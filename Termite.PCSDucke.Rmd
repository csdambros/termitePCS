---
title: "PCSinDuckeFor"
author: "CSDambros"
date: "05/19/2014"
output: html_document
---

Termites have a strong turnover along P content, but their densities are strongly associated with the density of predatory ants. 

Why are termite species replacing each other along the environmental gradients? 

Does the phylogenetic community structure indicates environmental filtering or competition to sort the species?

How ant density affects the co-occurrence of termite species? Are some termites more vulnerable to ant predation?


```{r Load Packages and functions}

library(ape)
library(picante)
library(tree)
library(vegan)

```


```{r import data}

isoptera<-read.csv("Isoptera.new.csv",row.names=1)

traits<-read.csv("species.traits2.csv",row.names=1)

isoptera$FG2<-traits$FG1[match(isoptera$Taxon,rownames(traits))]
isoptera$DEF<-traits$Maj[match(isoptera$Taxon,rownames(traits))]

# scholtz<-read.csv("scholtz.csv")
# scholtz.g<-do.call(rbind,strsplit(as.character(scholtz$spp)," "))[,1]
# 
# scholtz<-read.csv("genuses.csv")
# 
# traits<-cbind(traits,scholtz[match(isoptera$Genus[match(rownames(traits),isoptera$Taxon)],scholtz$genus),])
# 
# write.csv(traits,"species.traits2.csv")


#Removes repeated records of the same species in the same subplot (5x2 quadrant)

isoptera<-isoptera[!duplicated(isoptera[,c("Taxon","Location","Grid","Trail","Plot","Distance_beginning","Side")]),]

#TG<-tapply(isoptera$Trophic_group,isoptera$Taxon,function(x){levels(isoptera$Trophic_group)[sort(x[is.na(x)==F],decreasing = TRUE)[1]]})
#write.csv(as.data.frame(TG),"trophic.groups.csv")

iso.RFAD<-isoptera[isoptera$Grid=="RFAD",]

env<-read.csv("environment.csv")

env.RFAD<-cbind(env[env$Grid=="RFAD",1:7],read.csv("ducke.env.csv"))

```


```{r import phylo}

termite.phylo<-read.nexus("termitephylo.fix.nex")

#Correct old phylo tree (Ruptitermes was in the wrong place)

# termite.phylo<-read.nexus("termitephylo.nex")
# 
# plot(termite.phylo)
# nodelabels()
# 
# rupti<-extract.clade(termite.phylo,89)
# phylo.wrupti<-drop.tip(termite.phylo,c(7,8))
# 
# termite.phylo<-bind.tree(phylo.wrupti,rupti,114)
# 
# plot(termite.phylo)
# nodelabels()
# 
# termite.phylo$edge.length[c(1,7,12)]<-termite.phylo$edge.length[c(1,7,12)]-1
# termite.phylo$edge.length[75]<-termite.phylo$edge.length[75]+1
# 
# write.nexus(termite.phylo,file="termitephylo.fix.nex")

```

```{r extract_data_from_tables}

attach(iso.RFAD)

#write.csv(unique(data.frame(Location,Grid,Trail,Plot))[-c(1:148),],"jau.csv")

loc<-factor(paste(Location,Grid,Trail,Plot),levels=paste(env.RFAD$Location,env.RFAD$Grid,env.RFAD$Trail,env.RFAD$Plot))

loc.split<-unique(data.frame(env.RFAD$Location,env.RFAD$Grid,env.RFAD$Trail,env.RFAD$Plot))

#sum(loc!=paste(Location,Grid,Trail,Plot)) #Must be zero

termite.plot<-tapply(Frequency,list(loc,Taxon),sum)
termite.plot[is.na(termite.plot)]<-0
termite.plot<-termite.plot[,colSums(termite.plot)>0]

#cbind(rownames(termite.plot),env[,2:5]) #check if the environmental and termite tables are in the same order

termite.plot.PA<-(termite.plot>0)+0 # Easier and faster than ifelse(termite.plot>0,1,0)

# Species trophic group

TG.RFAD<-FG2[match(colnames(termite.plot),Taxon)]
DEF.RFAD<-DEF[match(colnames(termite.plot),Taxon)]


detach(iso.RFAD)

```


```{r create_response_variables}

### Simiarity indexes

sor.dist<-vegdist(termite.plot,"bray",binary = T)
sor.dist.w<-vegdist(termite.plot[,TG.RFAD=="W"],"bray",binary = T)
sor.dist.s<-vegdist(termite.plot[,TG.RFAD=="S"],"bray",binary = T)

### Total phylodiversity

ses.pd<-ses.pd(termite.plot[,],termite.phylo,null.model = "taxa.labels")
ses.mpd<-ses.mpd(termite.plot[,],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)
ses.mntd<-ses.mntd(termite.plot[,],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)

### Wood feeders phylodiversity

ses.pd.w<-ses.pd(termite.plot[,TG.RFAD=="W"],termite.phylo,null.model = "taxa.labels")
ses.mpd.w<-ses.mpd(termite.plot[,TG.RFAD=="W"],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)
ses.mntd.w<-ses.mntd(termite.plot[,TG.RFAD=="W"],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)

### Soil feeders phylodiversity

ses.pd.s<-ses.pd(termite.plot[,TG.RFAD=="S"],termite.phylo,null.model = "taxa.labels")
ses.mpd.s<-ses.mpd(termite.plot[,TG.RFAD=="S"],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)
ses.mntd.s<-ses.mntd(termite.plot[,TG.RFAD=="S"],cophenetic(termite.phylo),null.model = "taxa.labels",abundance.weighted=TRUE)


### Total phylocomposition

ufrac.dist<-unifrac(termite.plot,termite.phylo)
psor.dist<-phylosor(termite.plot,termite.phylo)
betaMNTD.dist<-comdistnt(termite.plot,cophenetic(termite.phylo))

### Wood-feeders phylocomposition

ufrac.dist.w<-unifrac(termite.plot[,TG.RFAD=="W"],termite.phylo)
psor.dist.w<-phylosor(termite.plot[,TG.RFAD=="W"],termite.phylo)
betaMNTD.dist.w<-comdistnt(termite.plot[,TG.RFAD=="W"],cophenetic(termite.phylo))

### Soil-feeders phylocomposition

ufrac.dist.s<-unifrac(termite.plot[,TG.RFAD=="S"],termite.phylo)
psor.dist.s<-phylosor(termite.plot[,TG.RFAD=="S"],termite.phylo)
betaMNTD.dist.s<-comdistnt(termite.plot[,TG.RFAD=="S"],cophenetic(termite.phylo))

```

```{r tests_for_phylogenetic_signal_in_traits}

#Calculate trait distance between species pairs (1 or 0 if categorical)

TGn<-as.integer(TG.RFAD)
names(TGn)<-colnames(termite.plot.PA)
TG.dist<-as.dist((((TGn)%*%t(TGn))-(TGn)^2)!=0)

DEFn<-as.integer(DEF.RFAD)
names(DEFn)<-colnames(termite.plot.PA)
DEF.dist<-as.dist((((DEFn)%*%t(DEFn))-(DEFn)^2)!=0)

#Calculate phylogenetic distance and rearrange columns to match species names in the data
phylo.dist<-cophenetic(termite.phylo)
phylo.dist<-as.dist(phylo.dist[match(colnames(termite.plot.PA),colnames(phylo.dist)),match(colnames(termite.plot.PA),colnames(phylo.dist))])

#####

dev.off()


par(mfrow=c(1,2),mar=c(5,2,4,2)+.1,oma=c(0,3,0,0),xpd=NA)

plot(1-tapply(as.vector(TG.dist),as.vector(phylo.dist),mean)~sort(unique(phylo.dist)),ylab="Probability of shared trait",xlab="Phylogenetic distance",cex.lab=1.5,pch=21,bg=1)

c1<-coef(glm(y~x,family=binomial(link="log"),data=data.frame(y=1-tapply(as.vector(TG.dist),as.vector(phylo.dist),mean),x=sort(unique(phylo.dist)))))

points(exp(cbind(1,seq(2,24,.1))%*%c1)~x,data=data.frame(x=seq(2,24,.1)),type="l")

title("A)",adj=0,cex.main=1.5)


plot(1-tapply(as.vector(DEF.dist),as.vector(phylo.dist),mean)~sort(unique(phylo.dist)),ylab="",xlab="Phylogenetic distance",cex.lab=1.5,pch=21,bg=1)

c1<-coef(glm(y~x,family=binomial(link="log"),start = c(a=0,b=-.5),data=data.frame(y=1-tapply(as.vector(DEF.dist),as.vector(phylo.dist),mean),x=sort(unique(phylo.dist)))))

points(exp(cbind(1,seq(2,24,.1))%*%c1)~x,data=data.frame(x=seq(2,24,.1)),type="l")

title("B)",adj=0,cex.main=1.5)

TG.mantel<-mantel.correlog(TG.dist,phylo.dist)

plot(TG.mantel$mantel.res[,3]~TG.mantel$mantel.res[,1],pch=21,bg=TG.mantel$mantel.res[,5]<0.05,xlim=c(2,12),type="o",ylab="Mantel correlation",xlab="Phylogenetic distance",cex.lab=1.5)
abline(h=0,lty=2,col=2)
	

Moran.I(TGn,as.matrix(phylo.dist))

###


DEF.mantel<-mantel.correlog(DEF.dist,phylo.dist)

plot(DEF.mantel$mantel.res[,3]~DEF.mantel$mantel.res[,1],pch=21,bg=DEF.mantel$mantel.res[,5]<0.05,xlim=c(2,12),type="o",ylab="Mantel correlation",xlab="Phylogenetic distance",cex.lab=1.5)
abline(h=0,lty=2,col=2)

Moran.I(DEFn,as.matrix(phylo.dist))

###


```

```{r Results: Association of diversity with environmental variables}

##Total

summary(lm(ses.pd$pd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.pd$pd.obs.z~env.RFAD$ant.nonpred.N))
summary(lm(ses.pd$pd.obs.z~env.RFAD$P))
summary(lm(ses.pd$pd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.pd$pd.obs.z~env.RFAD$Clay))

summary(lm(ses.mpd$mpd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mpd$mpd.obs.z~env.RFAD$P))
summary(lm(ses.mpd$mpd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mpd$mpd.obs.z~env.RFAD$Clay))

summary(lm(ses.mntd$mntd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mntd$mntd.obs.z~env.RFAD$P))
summary(lm(ses.mntd$mntd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mntd$mntd.obs.z~env.RFAD$Clay))

# Wood feeders

summary(lm(ses.pd.w$pd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.pd.w$pd.obs.z~env.RFAD$P))
summary(lm(ses.pd.w$pd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.pd.w$pd.obs.z~env.RFAD$Clay))

summary(lm(ses.mpd.w$mpd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mpd.w$mpd.obs.z~env.RFAD$P))
summary(lm(ses.mpd.w$mpd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mpd.w$mpd.obs.z~env.RFAD$Clay))

summary(lm(ses.mntd.w$mntd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mntd.w$mntd.obs.z~env.RFAD$P))
summary(lm(ses.mntd.w$mntd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mntd.w$mntd.obs.z~env.RFAD$Clay))

# Soil feeders

summary(lm(ses.pd.s$pd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.pd.s$pd.obs.z~env.RFAD$P))
summary(lm(ses.pd.s$pd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.pd.s$pd.obs.z~env.RFAD$Clay))

summary(lm(ses.mpd.s$mpd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mpd.s$mpd.obs.z~env.RFAD$P))
summary(lm(ses.mpd.s$mpd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mpd.s$mpd.obs.z~env.RFAD$Clay))

summary(lm(ses.mntd.s$mntd.obs.z~env.RFAD$ant.pred.N))
summary(lm(ses.mntd.s$mntd.obs.z~env.RFAD$P))
summary(lm(ses.mntd.s$mntd.obs.z~env.RFAD$N.percentage))
summary(lm(ses.mntd.s$mntd.obs.z~env.RFAD$Clay))

#### Multiple regressions

summary(lm(ses.pd$pd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mpd$mpd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mntd$mntd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))

summary(lm(ses.pd.w$pd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mpd.w$mpd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mntd.w$mntd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))

summary(lm(ses.pd.s$pd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mpd.s$mpd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))
summary(lm(ses.mntd.s$mntd.obs.z~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))



```

```{r plots}


par(mfrow=c(1,3),mar=c(5,2,4,2)+.1,oma=c(0,3,0,0),xpd=NA)

plot(ses.mntd$mntd.obs.z~env.RFAD$P,cex.lab=1.5,xlab="P content", ylab= "Phylogenetic diversity",pch=21,col=0,bg=1,cex=1.2,ylim=c(-2.5,2.5))

title("A)",adj=0,cex.main=1.5)

c1<-coef(nls(y~a+b*exp(c*x),start=list(a=-1,b=1,c=-0.2),data=data.frame(y=ses.mntd$mntd.obs.z,x=env.RFAD$P)))
points((c1[1]+c1[2]*exp(c1[3]*x))~x,data=data.frame(x=seq(-1,2.5,.1)),type="l")

plot(ses.mntd.w$mntd.obs.z~env.RFAD$P,cex.lab=1.5,xlab="P content", ylab= "",pch=21,col=0,bg=1,cex=1.2,ylim=c(-2.5,2.5))

title("B)",adj=0,cex.main=1.5)

c1<-coef(nls(y~a+b*exp(c*x),start=list(a=-3,b=5,c=-0.8),data=data.frame(y=ses.mntd.w$mntd.obs.z,x=env.RFAD$P)))
points((c1[1]+c1[2]*exp(c1[3]*x))~x,data=data.frame(x=seq(-1,2.5,.1)),type="l")

plot(ses.mntd.s$mntd.obs.z~env.RFAD$P,cex.lab=1.5,xlab="P content", ylab= "",pch=21,col=0,bg=1,cex=1.2,ylim=c(-2.5,2.5))

title("C)",adj=0,cex.main=1.5)

c1<-coef(nls(y~a+b*exp(c*x),start=list(a=1,b=1,c=0.2),data=data.frame(y=ses.mntd.s$mntd.obs.z,x=env.RFAD$P)))

points((c1[1]+c1[2]*exp(c1[3]*x))~x,data=data.frame(x=seq(-1,2.5,.1)),type="l")


# Plot termite phylogeny showing the distribution in trophic groups

op<-par(no.readonly=TRUE)

plot(termite.phylo, show.tip.label=F,plot=TRUE)

colors<-as.numeric(TG.RFAD)[match(termite.phylo$tip.label,colnames(termite.plot))]
colors[is.na(colors)]<-4

tiplabels(pch=22, col=0, bg=colors, cex=1.5,adj=.7)

###

#Plot the results for the total using MNTD (strongest relation)

par(op)

layout(matrix(c(1,1,2,1,1,2,1,1,3,1,1,3),3,4))

par(mar=c(5,5,4,2))
plot(ses.mntd$mntd.obs.z~env.RFAD$P,cex.lab=1.5,xlab="P content", ylab= "Phylogenetic diversity",pch=21,col=0,bg=1,cex=1.2)

title(main="A)",adj=0,cex.main=2)

par(mar=c(1,2,2,2))
plot(termite.phylo, show.tip.label=F,plot=TRUE)

#col.lowp<-termite.plot.PA[order(env.RFAD$P)==1,match(termite.phylo$tip.label,colnames(termite.plot))]

col.highmntd<-termite.plot.PA[order(ses.mntd$mntd.obs.z,decreasing = TRUE)==1,match(termite.phylo$tip.label,colnames(termite.plot))]

tiplabels(pch=22, col=col.highmntd, bg=colors*col.highmntd, cex=1,adj=1)

title(main="B)",adj=0,cex.main=2)

plot(termite.phylo, show.tip.label=F,plot=TRUE)

#col.highp<-termite.plot.PA[order(env.RFAD$P,decreasing = TRUE)==1,match(termite.phylo$tip.label,colnames(termite.plot))]

col.lowmntd<-termite.plot.PA[order(ses.mntd$mntd.obs.z)==1,match(termite.phylo$tip.label,colnames(termite.plot))]

tiplabels(pch=22, col=col.lowmntd, bg=colors*col.lowmntd, cex=1,adj=1)

title(main="C)",adj=0,cex.main=2)

par(op)

```

```{r poncho}

palette(c("#004CFFFF","black", "#00FF4DFF","#00E5FFFF","tomato","yellow","grey"))
	
poncho(termite.plot.PA,phy=termite.phylo,env=env.RFAD$P,col=as.integer(TG.RFAD)+1,file="phyloxPA",ylab.bottom = expression("P "(mg/dm^3)),xlab="Sampling units",col.gradient = "tomato",border="black")

poncho(termite.plot.PA,phy=termite.phylo,env=env.RFAD$P,col=as.integer(DEF.RFAD),file="phyloxPA.DEF",ylab.bottom = expression("P "(mg/dm^3)),xlab="Sampling units",col.gradient = "tomato",border="black")

poncho(termite.plot.PA,phy=termite.phylo,env=env.RFAD$ant.pred.N,col=as.integer(DEF.RFAD),file="phyloxPA.DEF.ant",ylab.bottom = "Ant density",xlab="Sampling units",col.gradient = "tomato",border="black")

poncho(termite.plot.PA,phy=termite.phylo,env=env.RFAD$ant.pred.N,col=as.integer(DEF.RFAD),ylab.bottom = "Ant density",xlab="Sampling units",col.gradient = "tomato",border="black")


palette("default")

```


```{r}

par(mar=c(0,0,0,0),oma=c(0,0,0,0))

layout(matrix(c(1,1,1,2,1,1,1,2),4,2))

sp.data<-termite.plot.PA
phy<-termite.phylo
env<-10*(2+env.RFAD$P)
xlab=expression("P content" (mg/dm^3))

sp.color<-as.integer(TG.RFAD)
z<-(t(t(sp.data)*sp.color))[order(env),match(phy$tip.label,colnames(sp.data))]

plot(phy, show.tip.label=F,plot=TRUE,no.margin = TRUE,x.lim=25)

space.x=(25-13.5)/31
space.y=1

x1=((z>0)*seq(13.5,25-space.x,length=nrow(z)))[(!is.na(z))&z>0]
y1=(t(t(z>0)*((1:length(phy$tip.label))-0.5)))[(!is.na(z))&z>0]

segments(13.4,1:length(phy$tip.label),25.25,1:length(phy$tip.label),lty=3,col="dark grey")

rect(x1,y1,x1+space.x,y1+space.y,col=c(1,4,3)[z[(!is.na(z))&z>0]])

plot(phy,plot=FALSE,no.margin = TRUE,x.lim=25)

rect(seq(13.5,25-space.x,length=nrow(z)),35,seq(13.5,25-space.x,length=nrow(z))+space,sort(env+35),col="dark grey")

text(25-(25-13.5)/2,15,xlab,cex=2)

segments(c(13.2,13.2,13.2),c(35,35,ceiling(max(env)+35)),c(13.2,13.2-.2,13.2-.2),c(ceiling(max(env)+35),35,ceiling(max(env)+35)))
text(13.2-.3,c(35,ceiling(max(env)+35)),c(0,ceiling(max(env))),adj=1)


```


```{r calculates pcoas of composition and phylogenetic composition}

pcoa.sor<-scores(cmdscale(sor.dist))

pcoa.psor<-scores(cmdscale(psor.dist))
pcoa.ufrac<-scores(cmdscale(ufrac.dist))

pcoa.sor.w<-scores(cmdscale(sor.dist.w))

pcoa.psor.w<-scores(cmdscale(psor.dist.w))
pcoa.ufrac.w<-scores(cmdscale(ufrac.dist.w))

pcoa.sor.s<-scores(cmdscale(sor.dist.s))
pcoa.psor.s<-scores(cmdscale(psor.dist.s))
pcoa.ufrac.s<-scores(cmdscale(ufrac.dist.s))


```


```{r regression of the first phylogenetic composition axis with environment}

summary(lm(pcoa.sor[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.sor[,1]~env.RFAD$P))
summary(lm(pcoa.sor[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.sor[,1]~env.RFAD$Clay))

summary(lm(pcoa.sor.w[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.sor.w[,1]~env.RFAD$P))
summary(lm(pcoa.sor.w[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.sor.w[,1]~env.RFAD$Clay))

summary(lm(pcoa.sor.s[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.sor.s[,1]~env.RFAD$P))
summary(lm(pcoa.sor.s[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.sor.s[,1]~env.RFAD$Clay))

###

summary(lm(pcoa.psor[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.psor[,1]~env.RFAD$P))
summary(lm(pcoa.psor[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.psor[,1]~env.RFAD$Clay))

summary(lm(pcoa.psor.w[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.psor.w[,1]~env.RFAD$P))
summary(lm(pcoa.psor.w[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.psor.w[,1]~env.RFAD$Clay))

summary(lm(pcoa.psor.s[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.psor.s[,1]~env.RFAD$P))
summary(lm(pcoa.psor.s[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.psor.s[,1]~env.RFAD$Clay))

###

summary(lm(pcoa.ufrac[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.ufrac[,1]~env.RFAD$P))
summary(lm(pcoa.ufrac[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.ufrac[,1]~env.RFAD$Clay))

summary(lm(pcoa.ufrac.w[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.ufrac.w[,1]~env.RFAD$P))
summary(lm(pcoa.ufrac.w[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.ufrac.w[,1]~env.RFAD$Clay))

summary(lm(pcoa.ufrac.s[,1]~env.RFAD$ant.pred.N))
summary(lm(pcoa.ufrac.s[,1]~env.RFAD$P))
summary(lm(pcoa.ufrac.s[,1]~env.RFAD$N.percentage))
summary(lm(pcoa.ufrac.s[,1]~env.RFAD$Clay))


```

```{r table1}

#####

table1<-lapply(list(ses.pd$pd.obs.z,ses.mpd$mpd.obs.z,ses.mntd$mntd.obs.z,pcoa.sor[,1],pcoa.psor[,1],pcoa.ufrac[,1],ses.pd.w$pd.obs.z,ses.mpd.w$mpd.obs.z,ses.mntd.w$mntd.obs.z,pcoa.sor.w[,1],pcoa.psor.w[,1],pcoa.ufrac.w[,1],ses.pd.s$pd.obs.z,ses.mpd.s$mpd.obs.z,ses.mntd.s$mntd.obs.z,pcoa.sor.s[,1],pcoa.psor.s[,1],pcoa.ufrac.s[,1]),function(x){
	
	c(m.var=coef(M1<-lm(x~ant.pred.N+P+N.percentage+Clay,data=env.RFAD))[-1],
		m.df=summary(M1)$df[2],
		m.F=summary(M1)$fstatistic[1],
		m.var.rsq=summary(M1)$r.squared*100,
		m.pval.p=anova(M1)[-5,"Pr(>F)"],
		m.pval.t=pf(summary(M1)$fstatistic[1], summary(M1)$fstatistic[2], summary(M1)$fstatistic[3],lower.tail = FALSE),		
		var=c(coef(update(M1,~ant.pred.N))[2],coef(update(M1,~P))[2],coef(update(M1,~N.percentage))[2],coef(update(M1,~Clay))[2]),
		pval=drop1(M1,test="F")[-1,"Pr(>F)"], 
		var.rsq=100*c(summary(update(M1,~ant.pred.N))$r.squared,summary(update(M1,~P))$r.squared,summary(update(M1,~N.percentage))$r.squared,summary(update(M1,~Clay))$r.squared))
	})

table1<-do.call(rbind,table1)

rownames(table1)<-rep(c("PD","MPD","MNTD","PCoA.sor","PCoA.psor","PCoA.ufrac"),3)# for all, wood, soil

write.csv((round(table1,3)),"Table1.raw.csv")	

pval.sym<-c("***"=0,"**"=0.001,"*"=0.01,"+"=0.05,0.1,1)

pval<-names(pval.sym)[as.integer(
	cut(table1[,grep("pval",colnames(table1))],breaks = pval.sym,include.lowest = T)
	)]

table1.f<-round(table1,3)

table1.f[,grep("var",colnames(table1.f))]<-paste(table1.f[,grep("var",colnames(table1.f))],pval,sep="")
table1.f<-table1.f[,-grep("pval",colnames(table1.f))]

colnames(table1.f)<-gsub("var.","",colnames(table1.f))

write.csv(table1.f,"Table1.final.csv")


```
##






```{r plot phylo compo x env}

plot(pcoa.psor[,1]~env.RFAD$ant.pred.N)
plot(pcoa.psor[,1]~env.RFAD$P)
plot(pcoa.psor[,1]~env.RFAD$N.percentage)
plot(pcoa.psor[,1]~env.RFAD$Clay)

plot(pcoa.psor.w[,1]~env.RFAD$ant.pred.N)
plot(pcoa.psor.w[,1]~env.RFAD$P)
plot(pcoa.psor.w[,1]~env.RFAD$N.percentage)
plot(pcoa.psor.w[,1]~env.RFAD$Clay)

plot(pcoa.psor.s[,1]~env.RFAD$ant.pred.N)
plot(pcoa.psor.s[,1]~env.RFAD$P)
plot(pcoa.psor.s[,1]~env.RFAD$N.percentage)
plot(pcoa.psor.s[,1]~env.RFAD$Clay)

plot(pcoa.ufrac[,1]~env.RFAD$ant.pred.N)
plot(pcoa.ufrac[,1]~env.RFAD$P)
plot(pcoa.ufrac[,1]~env.RFAD$N.percentage)
plot(pcoa.ufrac[,1]~env.RFAD$Clay)

plot(pcoa.ufrac.w[,1]~env.RFAD$ant.pred.N)
plot(pcoa.ufrac.w[,1]~env.RFAD$P)
plot(pcoa.ufrac.w[,1]~env.RFAD$N.percentage)
plot(pcoa.ufrac.w[,1]~env.RFAD$Clay)

plot(pcoa.ufrac.s[,1]~env.RFAD$ant.pred.N)
plot(pcoa.ufrac.s[,1]~env.RFAD$P)
plot(pcoa.ufrac.s[,1]~env.RFAD$N.percentage)
plot(pcoa.ufrac.s[,1]~env.RFAD$Clay)

##

```




